

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>python.tariff_functions &mdash; dGen Globetrotter 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> dGen Globetrotter
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/examples.html">Example Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/generating_agents.html">Generating Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/api.html">dGen Code Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/input_data.html">Input Data</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dGen Globetrotter</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>python.tariff_functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for python.tariff_functions</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions for determining the tariff</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="nn">req</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>


<span class="c1">#%%</span>
<span class="c1"># Load configuration file, if one exists.</span>
<div class="viewcode-block" id="load_config_params"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.load_config_params">[docs]</a><span class="k">def</span> <span class="nf">load_config_params</span><span class="p">(</span><span class="n">config_file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Each user should fill in a config_template.json file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;config.json&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">config</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="Tariff"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Tariff">[docs]</a><span class="k">class</span> <span class="nc">Tariff</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    urdb_id</span>
<span class="sd">        id for utility rate database. US, not international. </span>
<span class="sd">    eia_id</span>
<span class="sd">        The EIA assigned ID number for the utility associated with this tariff           </span>
<span class="sd">    name</span>
<span class="sd">        tariff name</span>
<span class="sd">    utility</span>
<span class="sd">        Name of utility this tariff is associated with</span>
<span class="sd">    fixed_charge</span>
<span class="sd">        Fixed monthly charge in $/mo.</span>
<span class="sd">    peak_kW_capacity_max</span>
<span class="sd">        The annual maximum kW of demand that a customer can have and still be on this tariff</span>
<span class="sd">    peak_kW_capacity_min</span>
<span class="sd">        The annula minimum kW of demand that a customer can have and still be on this tariff</span>
<span class="sd">    kWh_useage_max</span>
<span class="sd">        The maximum kWh of average monthly consumption that a customer can have and still be on this tariff</span>
<span class="sd">    kWh_useage_min</span>
<span class="sd">        The minimum kWh of average monthly consumption that a customer can have and still be on this tariff</span>
<span class="sd">    sector</span>
<span class="sd">        residential, commercial, or industrial</span>
<span class="sd">    comments</span>
<span class="sd">        comments from the urdb</span>
<span class="sd">    description</span>
<span class="sd">        tariff description from urdb</span>
<span class="sd">    source</span>
<span class="sd">        uri for the source of the tariff</span>
<span class="sd">    uri</span>
<span class="sd">        link the the urdb page</span>
<span class="sd">    voltage_category</span>
<span class="sd">        secondary, primary, transmission        </span>
<span class="sd">    d_flat_exists</span>
<span class="sd">        Boolean of whether there is a flat (not tou) demand charge component. Flat demand is also called monthly or seasonal demand. </span>
<span class="sd">    d_flat_n</span>
<span class="sd">        Number of unique flat demand period constructions. Does NOT correspond to width of d_flat_x constructs.</span>
<span class="sd">    d_flat_prices</span>
<span class="sd">        The prices of each tier/period combination for flat demand. Rows are tiers, columns are months. Differs from TOU, where columns are periods.</span>
<span class="sd">    d_flat_levels</span>
<span class="sd">        The limit (total kW) of each of each tier/period combination for flat demand. Rows are tiers, columns are months. Differs from TOU, where columns are periods.</span>
<span class="sd">    d_tou_exists</span>
<span class="sd">        Boolean of whether there is a tou (not flat) demand charge component</span>
<span class="sd">    d_tou_n</span>
<span class="sd">        Number of unique tou demand periods. Minimum of 1, since I&#39;m counting nocharge periods still as a period.</span>
<span class="sd">    d_tou_prices</span>
<span class="sd">        The prices of each tier/period combination for tou demand. Rows are tiers, columns are periods.    </span>
<span class="sd">    d_tou_levels</span>
<span class="sd">        The limit (total kW) of each of each tier/period combination for tou demand. Rows are tiers, columns are periods.</span>
<span class="sd">    e_exists</span>
<span class="sd">        Boolean of whether there is a flat (not tou) demand charge component</span>
<span class="sd">    e_tou_exists</span>
<span class="sd">        Boolean of whether there is a flat (not tou) demand charge component</span>
<span class="sd">    e_n</span>
<span class="sd">        Number of unique energy periods. Minimum of 1, since I&#39;m counting nocharge periods still as a period.</span>
<span class="sd">    e_prices</span>
<span class="sd">        The prices of each tier/period combination for flat demand. Rows are tiers, columns are periods.    </span>
<span class="sd">    e_levels</span>
<span class="sd">        The limit (total kWh) of each of each tier/period combination for energy. Rows are tiers, columns are periods.</span>
<span class="sd">    e_wkday_12by24</span>
<span class="sd">        12 by 24 period definition for weekday energy. Rows are months, columns are hours.</span>
<span class="sd">    e_wkend_12by24</span>
<span class="sd">        12 by 24 period definition for weekend energy. Rows are months, columns are hours.</span>
<span class="sd">    d_wkday_12by24</span>
<span class="sd">        12 by 24 period definition for weekday energy. Rows are months, columns are hours.</span>
<span class="sd">    d_wkend_12by24</span>
<span class="sd">        12 by 24 period definition for weekend energy. Rows are months, columns are hours.</span>
<span class="sd">    d_tou_8760</span>
<span class="sd">        8760 of tou demand prices.</span>
<span class="sd">    e_tou_8760</span>
<span class="sd">        8760 of tou energy prices.</span>
<span class="sd">    e_prices_no_tier</span>
<span class="sd">    e_max_difference</span>
<span class="sd">        The maximum energy price differential within any single day</span>
<span class="sd">    energy_rate_unit</span>
<span class="sd">        kWh or kWh/day, for guiding the bill calculations later</span>
<span class="sd">    demand_rate_unit</span>
<span class="sd">        kW or kW/day, for guiding the bill calculations later</span>
<span class="sd">    </span>
<span class="sd">    Todo</span>
<span class="sd">    ----</span>
<span class="sd">    Peak_kW_capacity and other scalar variables may be being imported as tuples.</span>
<span class="sd">    this may have been solved now, but general unit check would be good.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
<div class="viewcode-block" id="Tariff.__init__"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Tariff.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_day</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">urdb_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dict_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Create a Tariff Function object based on a urdb id, a .csv file, or a blank tariff is created.&quot;</span>            
        <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;eia_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>           
        <span class="k">if</span> <span class="n">urdb_id</span><span class="o">==</span><span class="kc">None</span> <span class="ow">and</span> <span class="n">json_file_name</span><span class="o">==</span><span class="kc">None</span> <span class="ow">and</span> <span class="n">dict_obj</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default values for a blank tariff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">urdb_id</span> <span class="o">=</span> <span class="s1">&#39;No urdb id given&#39;</span>               
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;User defined tariff - no name specified&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">utility</span> <span class="o">=</span> <span class="s1">&#39;User defined tariff - no name specified&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_charge</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_max</span> <span class="o">=</span> <span class="mf">1e99</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_max</span> <span class="o">=</span> <span class="mf">1e99</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sector</span> <span class="o">=</span> <span class="s1">&#39;No sector specified&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;No comments given&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;No description given&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;No source given&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;No uri given&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">voltage_category</span> <span class="o">=</span> <span class="s1">&#39;No voltage category given&#39;</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">eia_id</span> <span class="o">=</span> <span class="s1">&#39;No eia id given&#39;</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">demand_rate_unit</span> <span class="o">=</span> <span class="s1">&#39;kW&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_rate_unit</span> <span class="o">=</span> <span class="s1">&#39;kWh&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="o">=</span> <span class="mi">6</span>
            
            
            <span class="c1">###################### Blank Flat Demand Structure ########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>     
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1e9</span>
                
            
            <span class="c1">#################### Blank Demand TOU Structure ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>     
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            
            
            <span class="c1">################ Blank Coincident Peak Structure ##################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coincident_peak_exists</span> <span class="o">=</span> <span class="kc">False</span>            

            
            <span class="c1">######################## Blank Energy Structure ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>     
            <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            
                
            <span class="c1">######################## Blank Schedules ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            
            
            <span class="c1">################### Blank 12x24s as 8760s Schedule ########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_8760</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_8760</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            
            
            <span class="c1">######################## Precalculations ######################################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_max_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        
        <span class="c1">#######################################################################</span>
        <span class="c1"># If given a urdb_id input argument, obtain and reshape that tariff through the URDB API </span>
        <span class="c1">#######################################################################</span>
        <span class="k">elif</span> <span class="n">urdb_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">api_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No URDB API key defined.&quot;</span><span class="p">)</span>
            
            <span class="n">input_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                        <span class="s1">&#39;format&#39;</span><span class="p">:</span><span class="s1">&#39;json&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;detail&#39;</span><span class="p">:</span><span class="s1">&#39;full&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;getpage&#39;</span><span class="p">:</span><span class="n">urdb_id</span><span class="p">,</span>
                        <span class="s1">&#39;api_key&#39;</span><span class="p">:</span><span class="n">api_key</span><span class="p">}</span>
                        
            <span class="n">r</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.openei.org/utility_rates?&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">input_params</span><span class="p">)</span>
        
            <span class="n">content</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>
            <span class="n">tariff_original</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;demandrateunit&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand_rate_unit</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;demandrateunit&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand_rate_unit</span> <span class="o">=</span> <span class="s1">&#39;kW&#39;</span>  
              
            <span class="k">if</span> <span class="s1">&#39;eiaid&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eia_id</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;eiaid&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eia_id</span> <span class="o">=</span> <span class="s1">&#39;No eia id given&#39;</span>                 
                
            <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdb_id</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdb_id</span> <span class="o">=</span> <span class="s1">&#39;No urdb id given&#39;</span>            
            
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;No name specified&#39;</span>
                
            <span class="k">if</span> <span class="s1">&#39;utility&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;utility&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility</span> <span class="o">=</span> <span class="s1">&#39;No utility specified&#39;</span>
                
            <span class="k">if</span> <span class="s1">&#39;fixedmonthlycharge&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_charge</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;fixedmonthlycharge&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_charge</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="k">if</span> <span class="s1">&#39;peakkwcapacitymax&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_max</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;peakkwcapacitymax&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_max</span> <span class="o">=</span> <span class="mf">1e99</span>
                
            <span class="k">if</span> <span class="s1">&#39;peakkwcapacitymin&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_min</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;peakkwcapacitymin&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_min</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="k">if</span> <span class="s1">&#39;peakkwhusagemax&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_max</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;peakkwhusagemax&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_max</span> <span class="o">=</span> <span class="mf">1e99</span>
                
            <span class="k">if</span> <span class="s1">&#39;peakkwhusagemin&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_min</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;peakkwhusagemin&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_min</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="k">if</span> <span class="s1">&#39;sector&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector</span> <span class="o">=</span> <span class="s1">&#39;No sector given&#39;</span>
                
            <span class="k">if</span> <span class="s1">&#39;basicinformationcomments&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;basicinformationcomments&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;No comments&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;No description&#39;</span>
                
            <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;No source given&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;uri&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;No uri given&#39;</span>
                
            <span class="k">if</span> <span class="s1">&#39;voltage_category&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voltage_category</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;voltage_category&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voltage_category</span> <span class="o">=</span> <span class="s1">&#39;No voltage category given&#39;</span>
                 
            
            <span class="c1">###################### Repackage Flat Demand Structure ########################</span>
            <span class="k">if</span> <span class="s1">&#39;flatdemandstructure&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">d_flat_structure</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;flatdemandstructure&#39;</span><span class="p">]</span>
                <span class="n">d_flat_month_indicies</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;flatdemandmonths&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;flatdemandmonths&#39;</span><span class="p">]))</span>
                
                <span class="c1"># Determine the maximum number of tiers in the demand structure</span>
                <span class="n">max_tiers</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span><span class="p">):</span>
                    <span class="n">n_tiers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_flat_structure</span><span class="p">[</span><span class="n">period</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">n_tiers</span> <span class="o">&gt;</span> <span class="n">max_tiers</span><span class="p">:</span> <span class="n">max_tiers</span> <span class="o">=</span> <span class="n">n_tiers</span>
                
                <span class="c1"># Repackage Energy TOU Structure   </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_tiers</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>     
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_tiers</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1e9</span>
                <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_flat_structure</span><span class="p">[</span><span class="n">period</span><span class="p">])):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span><span class="p">[</span><span class="n">tier</span><span class="p">,</span> <span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_flat_structure</span><span class="p">[</span><span class="n">d_flat_month_indicies</span><span class="p">[</span><span class="n">month</span><span class="p">]][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span><span class="p">[</span><span class="n">tier</span><span class="p">,</span> <span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_flat_structure</span><span class="p">[</span><span class="n">d_flat_month_indicies</span><span class="p">[</span><span class="n">month</span><span class="p">]][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">d_flat_structure</span><span class="p">[</span><span class="n">d_flat_month_indicies</span><span class="p">[</span><span class="n">month</span><span class="p">]][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adj&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>     
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1e9</span>
            
            <span class="c1">#################### Repackage Demand TOU Structure ###########################</span>
            <span class="k">if</span> <span class="s1">&#39;demandratestructure&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span>
                <span class="n">demand_structure</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;demandratestructure&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">demand_structure</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="c1"># Determine the maximum number of tiers in the demand structure</span>
                <span class="n">max_tiers</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">):</span>
                    <span class="n">n_tiers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">demand_structure</span><span class="p">[</span><span class="n">period</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">n_tiers</span> <span class="o">&gt;</span> <span class="n">max_tiers</span><span class="p">:</span> <span class="n">max_tiers</span> <span class="o">=</span> <span class="n">n_tiers</span>
                
                <span class="c1"># Repackage Demand TOU Structure   </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_tiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">])</span>     
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_tiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1e9</span>
                <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">demand_structure</span><span class="p">[</span><span class="n">period</span><span class="p">])):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span><span class="p">[</span><span class="n">tier</span><span class="p">,</span> <span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="n">demand_structure</span><span class="p">[</span><span class="n">period</span><span class="p">][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span><span class="p">[</span><span class="n">tier</span><span class="p">,</span> <span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="n">demand_structure</span><span class="p">[</span><span class="n">period</span><span class="p">][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">demand_structure</span><span class="p">[</span><span class="n">period</span><span class="p">][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adj&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>     
                <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            
            <span class="c1">######################## No Coincident Peak from URDB #############</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coincident_peak_exists</span> <span class="o">=</span> <span class="kc">False</span>
            
            
            <span class="c1">######################## Repackage Energy Structure ###########################</span>
            <span class="k">if</span> <span class="s1">&#39;energyratestructure&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">energy_structure</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;energyratestructure&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy_rate_unit</span> <span class="o">=</span> <span class="n">energy_structure</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span><span class="s1">&#39;kWh&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy_structure</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># Determine the maximum number of tiers in the demand structure</span>
                <span class="n">max_tiers</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_n</span><span class="p">):</span>
                    <span class="n">n_tiers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy_structure</span><span class="p">[</span><span class="n">period</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">n_tiers</span> <span class="o">&gt;</span> <span class="n">max_tiers</span><span class="p">:</span> <span class="n">max_tiers</span> <span class="o">=</span> <span class="n">n_tiers</span>
                
                <span class="c1"># Repackage Energy TOU Structure   </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_tiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span><span class="p">])</span>     
                <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_tiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1e9</span>
                <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_n</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_structure</span><span class="p">[</span><span class="n">period</span><span class="p">])):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span><span class="p">[</span><span class="n">tier</span><span class="p">,</span> <span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_structure</span><span class="p">[</span><span class="n">period</span><span class="p">][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span><span class="p">[</span><span class="n">tier</span><span class="p">,</span> <span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_structure</span><span class="p">[</span><span class="n">period</span><span class="p">][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">energy_structure</span><span class="p">[</span><span class="n">period</span><span class="p">][</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adj&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>     
                <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy_rate_unit</span> <span class="o">=</span> <span class="s1">&#39;kWh&#39;</span>
                
            <span class="c1">######################## Repackage Energy Schedule ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;energyweekdayschedule&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;energyweekdayschedule&#39;</span><span class="p">][</span><span class="n">month</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;energyweekendschedule&#39;</span><span class="p">][</span><span class="n">month</span><span class="p">]</span>
                    
            <span class="c1"># If the urdb 12by24 has a period that isn&#39;t defined in the tiers,</span>
            <span class="c1"># set that period to the 0th tier.</span>
            <span class="n">max_e_period_in_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">])</span>
            <span class="n">max_e_period_in_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_e_period_in_prices</span><span class="p">,</span> <span class="n">max_e_period_in_matrix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1">######################## Repackage Demand Schedule ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;demandweekdayschedule&#39;</span> <span class="ow">in</span> <span class="n">tariff_original</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;demandweekdayschedule&#39;</span><span class="p">][</span><span class="n">month</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tariff_original</span><span class="p">[</span><span class="s1">&#39;demandweekendschedule&#39;</span><span class="p">][</span><span class="n">month</span><span class="p">]</span>
                    
            <span class="c1"># If the urdb 12by24 has a period that isn&#39;t defined in the tiers,</span>
            <span class="c1"># set that period to the 0th tier.</span>
            <span class="n">max_d_period_in_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="p">])</span>
            <span class="n">max_d_period_in_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_d_period_in_prices</span><span class="p">,</span> <span class="n">max_d_period_in_matrix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1">################### Repackage 12x24s as 8760s Schedule ########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="o">=</span> <span class="n">start_day</span>                               
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_8760</span> <span class="o">=</span> <span class="n">build_8760_from_12by24s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_8760</span> <span class="o">=</span> <span class="n">build_8760_from_12by24s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span><span class="p">)</span>

            
            <span class="c1">######################## Precalculations ######################################</span>
            <span class="c1"># Collapse the tiered price matrix down to just the maximum cost</span>
            <span class="c1"># in each tier, to be used during dispatch.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Determine the maximum differential in energy price within a day.</span>
            <span class="n">e_12by24_max_prices_wkday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">]</span>
            <span class="n">e_12by24_max_prices_wkend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">]</span>
            <span class="n">e_max_price_differential_wkday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkday</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkday</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">e_max_price_differential_wkend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkend</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkend</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_max_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">e_max_price_differential_wkday</span><span class="p">,</span> <span class="n">e_max_price_differential_wkend</span><span class="p">])</span>

        
        <span class="c1">#######################################################################</span>
        <span class="c1"># If given a json input argument, construct a tariff from that file</span>
        <span class="c1">#######################################################################    </span>
        <span class="k">elif</span> <span class="n">json_file_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj_text</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">json_file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">obj_text</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fieldname</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fieldname</span><span class="p">])</span>
                
            <span class="k">if</span> <span class="s1">&#39;urdb_id&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdb_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;urdb_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;utility&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utility&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;fixed_charge&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_charge</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fixed_charge&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;peak_kW_capacity_max&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_max</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;peak_kW_capacity_max&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;peak_kW_capacity_min&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_min</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;peak_kW_capacity_min&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;kWh_useage_max&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_max</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kWh_useage_max&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;kWh_useage_min&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_min</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kWh_useage_min&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;sector&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;uri&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;voltage_category&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voltage_category</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;voltage_category&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;eia_id&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eia_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;eia_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;energy_rate_unit&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_rate_unit</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;energy_rate_unit&#39;</span><span class="p">]</span>
            
            
            <span class="c1">###################### Blank Flat Demand Structure ########################</span>
            <span class="k">if</span> <span class="s1">&#39;d_flat_exists&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_flat_exists&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_flat_prices&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_flat_prices&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_flat_levels&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_flat_levels&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_flat_n&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_flat_n&#39;</span><span class="p">]</span>
                
            
            <span class="c1">#################### Blank Demand TOU Structure ###########################</span>
            <span class="k">if</span> <span class="s1">&#39;d_tou_exists&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_tou_exists&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_tou_n&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_tou_n&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_tou_prices&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_tou_prices&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_tou_levels&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_tou_levels&#39;</span><span class="p">]</span>

            
            <span class="c1">#################### Coincident Peak Structure ###########################            </span>
            <span class="k">if</span> <span class="s1">&#39;coincident_peak_exists&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_peak_exists</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coincident_peak_exists&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_peak_exists</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="s1">&#39;coincident_style&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_style</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coincident_style&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_hour_def&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_hour_def</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coincident_hour_def&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_prices&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_prices</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coincident_prices&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_levels&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_levels</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coincident_levels&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_monthly_periods&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_monthly_periods</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coincident_monthly_periods&#39;</span><span class="p">]</span>
            
            
            <span class="c1">######################## Blank Energy Structure ###########################</span>
            <span class="k">if</span> <span class="s1">&#39;e_exists&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_exists</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_exists&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;e_tou_exists&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_exists</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_tou_exists&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;e_n&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_n&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;e_prices&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_prices&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;e_levels&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_levels&#39;</span><span class="p">]</span>
            
                
            <span class="c1">######################## Blank Schedules ###########################</span>
            <span class="k">if</span> <span class="s1">&#39;e_wkday_12by24&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_wkday_12by24&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;e_wkend_12by24&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_wkend_12by24&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_wkday_12by24&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_wkday_12by24&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;d_wkend_12by24&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_wkend_12by24&#39;</span><span class="p">]</span>
            
            
            <span class="c1">################### Blank 12x24s as 8760s Schedule ########################</span>
            <span class="k">if</span> <span class="s1">&#39;d_tou_8760&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_8760</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;d_tou_8760&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;e_tou_8760&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_8760</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_tou_8760&#39;</span><span class="p">]</span>
            
            
            <span class="c1">######################## Precalculations ######################################</span>
            <span class="k">if</span> <span class="s1">&#39;e_prices_no_tier&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_prices_no_tier&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;e_max_difference&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_max_difference</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;e_max_difference&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;start_day&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;start_day&#39;</span><span class="p">]</span>

            
        <span class="c1">#######################################################################</span>
        <span class="c1"># If given a dict input, construct a tariff from that object</span>
        <span class="c1">#######################################################################    </span>
        <span class="k">elif</span> <span class="n">dict_obj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;start_day&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;start_day&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="o">=</span> <span class="mi">6</span>

            <span class="k">if</span> <span class="s1">&#39;urdb_id&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdb_id</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;urdb_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;utility&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;utility&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;sector&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;uri&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;voltage_category&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voltage_category</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;voltage_category&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_charge</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;fixed_charge&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_max</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;peak_kW_capacity_max&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_kW_capacity_min</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;peak_kW_capacity_min&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_max</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;kWh_useage_max&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kWh_useage_min</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;kWh_useage_min&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eia_id</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;eia_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;demand_rate_unit&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand_rate_unit</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;demand_rate_unit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;energy_rate_unit&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_rate_unit</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;energy_rate_unit&#39;</span><span class="p">]</span>
            
            <span class="c1">###################### Flat Demand Structure ########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_flat_exists&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_flat_prices&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_flat_levels&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_flat_n&#39;</span><span class="p">]</span>
            
            <span class="c1">#################### Demand TOU Structure ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_tou_exists&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_tou_n&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_tou_prices&#39;</span><span class="p">])</span>    
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_tou_levels&#39;</span><span class="p">])</span>
            
            <span class="c1">#################### Coincident Peak Structure ###########################            </span>
            <span class="k">if</span> <span class="s1">&#39;coincident_peak_exists&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_peak_exists</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;coincident_peak_exists&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_peak_exists</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="s1">&#39;coincident_style&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_style</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;coincident_style&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_hour_def&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_hour_def</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;coincident_hour_def&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_prices&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_prices</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;coincident_prices&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_levels&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_levels</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;coincident_levels&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;coincident_monthly_periods&#39;</span> <span class="ow">in</span> <span class="n">dict_obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coincident_monthly_periods</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;coincident_monthly_periods&#39;</span><span class="p">]</span>
            
            
            <span class="c1">######################## Energy Structure ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_exists</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_exists&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_exists</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_tou_exists&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_n&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_prices&#39;</span><span class="p">])</span>   
            <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_levels&#39;</span><span class="p">])</span>
            
            <span class="c1">######################## Schedules ###########################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_wkday_12by24&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_wkend_12by24&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_wkday_12by24&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;d_wkend_12by24&#39;</span><span class="p">])</span>

            <span class="c1"># If the 12by24 has a period that isn&#39;t defined in the tiers,</span>
            <span class="c1"># set that period to the 0th tier.</span>
            <span class="n">max_e_period_in_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">])</span>

            <span class="n">max_e_period_in_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_e_period_in_prices</span><span class="p">,</span> <span class="n">max_e_period_in_matrix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># If the 12by24 has a period that isn&#39;t defined in the tiers,</span>
            <span class="c1"># set that period to the 0th tier.</span>
            <span class="n">max_d_period_in_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="p">])</span>
            <span class="n">max_d_period_in_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_d_period_in_prices</span><span class="p">,</span> <span class="n">max_d_period_in_matrix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="o">==</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                   
            <span class="c1">################### 12x24s as 8760s Schedule ########################</span>
            <span class="c1"># Build 8760&#39;s. Note that any ingested 8760&#39;s will be ignored                              </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_8760</span> <span class="o">=</span> <span class="n">build_8760_from_12by24s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_8760</span> <span class="o">=</span> <span class="n">build_8760_from_12by24s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span><span class="p">)</span>                 
            
            <span class="c1">######################## Precalculations ######################################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_prices_no_tier&#39;</span><span class="p">])</span> <span class="c1"># simplification until something better is implemented</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_max_difference</span> <span class="o">=</span> <span class="n">dict_obj</span><span class="p">[</span><span class="s1">&#39;e_max_difference&#39;</span><span class="p">]</span></div>
            
<div class="viewcode-block" id="Tariff.write_json"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Tariff.write_json">[docs]</a>    <span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the current class object to a json file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_file_name : str</span>
<span class="sd">            Path to output file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
                
        <span class="n">d_prep_for_json</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># change ndarray dtypes to lists, since json doesn&#39;t know ndarrays</span>
        <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">d_prep_for_json</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_prep_for_json</span><span class="p">[</span><span class="n">fieldname</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">d_prep_for_json</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_prep_for_json</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d_prep_for_json</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div>
                     
<div class="viewcode-block" id="Tariff.define_d_tou"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Tariff.define_d_tou">[docs]</a>    <span class="k">def</span> <span class="nf">define_d_tou</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="n">d_wkend_12by24</span><span class="p">,</span> <span class="n">d_tou_levels</span><span class="p">,</span> <span class="n">d_tou_prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define TOU demand charge periods, levels, and prices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_levels</span> <span class="o">=</span> <span class="n">d_tou_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_prices</span> <span class="o">=</span> <span class="n">d_tou_prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_wkday_12by24</span> <span class="o">=</span> <span class="n">d_wkday_12by24</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_wkend_12by24</span> <span class="o">=</span> <span class="n">d_wkend_12by24</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">d_tou_levels</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">d_tou_prices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="kc">True</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_8760</span> <span class="o">=</span> <span class="n">build_8760_from_12by24s</span><span class="p">(</span><span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="n">d_wkend_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span><span class="p">)</span></div>
       
<div class="viewcode-block" id="Tariff.define_d_flat"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Tariff.define_d_flat">[docs]</a>    <span class="k">def</span> <span class="nf">define_d_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_flat_levels</span><span class="p">,</span> <span class="n">d_flat_prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define flat demand charge periods, levels, and prices. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># If it is only handed one value for levels and prices, it assumes that</span>
        <span class="c1"># value applies to all months</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">d_flat_prices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">d_flat_levels</span><span class="p">]])</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">d_flat_prices</span><span class="p">]])</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_levels</span> <span class="o">=</span> <span class="n">d_flat_levels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">d_flat_prices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">d_flat_prices</span><span class="p">))</span>
        

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d_flat_prices</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">=</span> <span class="kc">True</span></div>
              
<div class="viewcode-block" id="Tariff.define_e"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Tariff.define_e">[docs]</a>    <span class="k">def</span> <span class="nf">define_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e_wkday_12by24</span><span class="p">,</span> <span class="n">e_wkend_12by24</span><span class="p">,</span> <span class="n">e_levels</span><span class="p">,</span> <span class="n">e_prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define energy periods, levels, and prices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">e_levels</span> <span class="o">=</span> <span class="n">e_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span> <span class="o">=</span> <span class="n">e_prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span> <span class="o">=</span> <span class="n">e_wkday_12by24</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span> <span class="o">=</span> <span class="n">e_wkend_12by24</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">e_levels</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Are there any energy charges?</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">e_prices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_exists</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Are there any TOU energy charges?</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">e_wkday_12by24</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">e_wkday_12by24</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">)):</span> <span class="c1"># TODO: add weekends</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_exists</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">e_tou_8760</span> <span class="o">=</span> <span class="n">build_8760_from_12by24s</span><span class="p">(</span><span class="n">e_wkday_12by24</span><span class="p">,</span> <span class="n">e_wkend_12by24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span><span class="p">)</span>

                
        <span class="c1">######################## Precalculations ######################################</span>
        <span class="c1"># Collapse the tiered price matrix down to just the maximum cost</span>
        <span class="c1"># in each tier, to be used during dispatch.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_prices</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Determine the maximum differential in energy price within a day.</span>
        <span class="n">e_12by24_max_prices_wkday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkday_12by24</span><span class="p">]</span>
        <span class="n">e_12by24_max_prices_wkend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_prices_no_tier</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e_wkend_12by24</span><span class="p">]</span>
        <span class="n">e_max_price_differential_wkday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkday</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkday</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">e_max_price_differential_wkend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkend</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_12by24_max_prices_wkend</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_max_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">e_max_price_differential_wkday</span><span class="p">,</span> <span class="n">e_max_price_differential_wkend</span><span class="p">])</span></div></div>
                            
                 
<span class="c1">#%%     </span>
<div class="viewcode-block" id="Export_Tariff"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Export_Tariff">[docs]</a><span class="k">class</span> <span class="nc">Export_Tariff</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structure of compensation for exported generation.</span>
<span class="sd">    </span>
<span class="sd">    Currently only two styles: full-retail NEM, and instantanous TOU energy value. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_retail_nem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
                 <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
                 <span class="n">periods_8760</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                 <span class="n">period_tou_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_retail_nem</span> <span class="o">=</span> <span class="n">full_retail_nem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>     
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periods_8760</span> <span class="o">=</span> <span class="n">periods_8760</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period_tou_n</span> <span class="o">=</span> <span class="n">period_tou_n</span>
        
<div class="viewcode-block" id="Export_Tariff.set_constant_sell_price"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.Export_Tariff.set_constant_sell_price">[docs]</a>    <span class="k">def</span> <span class="nf">set_constant_sell_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_retail_nem</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">price</span><span class="p">]],</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">9999999</span><span class="p">]],</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periods_8760</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period_tou_n</span> <span class="o">=</span> <span class="mi">1</span></div></div>

<span class="c1">#%%</span>
<div class="viewcode-block" id="tiered_calc_vec"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.tiered_calc_vec">[docs]</a><span class="k">def</span> <span class="nf">tiered_calc_vec</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
    <span class="c1"># Vectorized piecewise function calculator</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">prices</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Tier 1</span>
<span class="c1"># commenting the line below to account for the exported generation (-ve values) also receiving NEM incentives</span>
<span class="c1">#    y += ((values &gt;= 0) &amp; (values &lt; levels[:][:][0])) * (values*prices[:][:][0])</span>


    <span class="n">addition</span> <span class="o">=</span> <span class="p">((</span><span class="n">values</span> <span class="o">&lt;</span> <span class="n">levels</span><span class="p">[:][:][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">values</span><span class="o">*</span><span class="n">prices</span><span class="p">[:][:][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">((</span><span class="n">values</span> <span class="o">&lt;</span> <span class="n">levels</span><span class="p">[:][:][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">values</span><span class="o">*</span><span class="n">prices</span><span class="p">[:][:][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Tiers 2 and beyond    </span>
    <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">((</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">levels</span><span class="p">[:][:][</span><span class="n">tier</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">values</span> <span class="o">&lt;</span> <span class="n">levels</span><span class="p">[:][:][</span><span class="n">tier</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">((</span><span class="n">values</span><span class="o">-</span><span class="n">levels</span><span class="p">[:][:][</span><span class="n">tier</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">prices</span><span class="p">[:][:][</span><span class="n">tier</span><span class="p">])</span> <span class="o">+</span> <span class="n">levels</span><span class="p">[:][:][</span><span class="n">tier</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">prices</span><span class="p">[:][:][</span><span class="n">tier</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  
    <span class="k">return</span> <span class="n">y</span></div>

<span class="c1">#%%</span>

<div class="viewcode-block" id="bill_calculator"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.bill_calculator">[docs]</a><span class="k">def</span> <span class="nf">bill_calculator</span><span class="p">(</span><span class="n">load_profile</span><span class="p">,</span> <span class="n">tariff</span><span class="p">,</span> <span class="n">export_tariff</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Not vectorized for now. Next step will be pass in multiple profiles for the same tariff</span>
<span class="sd">    2 styles of NEM: Full retail and fixed schedule value. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    load_profile : 8760 profile of agent</span>
<span class="sd">    tariff : :class:`python.tariff_functions.Tariff`</span>
<span class="sd">        Tariff class object</span>
<span class="sd">    export_tariff : :class:`python.tariff_functions.Export_Tariff`</span>
<span class="sd">        Export tariff class object</span>


<span class="sd">    Todo</span>
<span class="sd">    ----</span>
<span class="sd">    1)  Both energy and demand calcs (anything that uses piecewise calculator) doesn&#39;t go below zero, because piecewise isn&#39;t built to.</span>
<span class="sd">        Therefore, credit can&#39;t be earned in one period and applied to another. </span>
<span class="sd">    2)  My current approach sums for all periods, not just those in a month. Potentially inefficient, if it was dynamic it would be cheaper, but less clear.</span>
<span class="sd">    3)  Make this flexible for different hours increments (which will require more robust approach for power vs energy units)</span>
<span class="sd">    4)  Not sure what happens if there is no energy component in the tariff, at the moment    </span>
<span class="sd">    5)  I haven&#39;t checked the TOU export credit option yet.</span>
<span class="sd">    6)  I don&#39;t make any type of check about what day of the week this calculator assumes your load profile is starting on `e_period_charges` wasn&#39;t being built for non-NEM</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">n_months</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">n_timesteps</span> <span class="o">=</span> <span class="mi">8760</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_8760</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8760</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Non-8760 profiles are not yet supported by the bill calculator&#39;</span><span class="p">)</span>
    
    <span class="c1"># 8760 vector of month numbers</span>
    <span class="n">month_hours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">744</span><span class="p">,</span> <span class="mi">1416</span><span class="p">,</span> <span class="mi">2160</span><span class="p">,</span> <span class="mi">2880</span><span class="p">,</span> <span class="mi">3624</span><span class="p">,</span> <span class="mi">4344</span><span class="p">,</span> <span class="mi">5088</span><span class="p">,</span> <span class="mi">5832</span><span class="p">,</span> <span class="mi">6552</span><span class="p">,</span> <span class="mi">7296</span><span class="p">,</span> <span class="mi">8016</span><span class="p">,</span> <span class="mi">8760</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">month_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">month</span><span class="p">,</span> <span class="n">hours</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">month_hours</span><span class="p">):</span>
        <span class="n">month_index</span><span class="p">[</span><span class="n">month_hours</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">hours</span><span class="p">]</span> <span class="o">=</span> <span class="n">month</span><span class="o">-</span><span class="mi">1</span>
        
    <span class="c1">#=========================================================================#</span>
    <span class="c1">################## Calculate TOU Demand Charges ###########################</span>
    <span class="c1">#=========================================================================#</span>
    <span class="k">if</span> <span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_exists</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Cast the TOU periods into a boolean matrix</span>
        <span class="n">period_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_timesteps</span><span class="p">,</span> <span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_n</span><span class="o">*</span><span class="n">n_months</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">period_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">)),</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_8760</span><span class="o">+</span><span class="n">month_index</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Determine the max demand in each period of each month of each year</span>
        <span class="n">load_distributed</span> <span class="o">=</span> <span class="n">load_profile</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">period_matrix</span>
        <span class="n">period_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Calculate the cost of TOU demand charges</span>
        <span class="n">d_TOU_period_charges</span> <span class="o">=</span> <span class="n">tiered_calc_vec</span><span class="p">(</span><span class="n">period_maxs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">],</span> <span class="mi">12</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_prices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">],</span> <span class="mi">12</span><span class="p">))</span>
       
        <span class="n">d_TOU_month_total_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_months</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_months</span><span class="p">):</span>
            <span class="n">d_TOU_month_total_charges</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_TOU_period_charges</span><span class="p">[(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">):(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_n</span> <span class="o">+</span> <span class="n">tariff</span><span class="o">.</span><span class="n">d_tou_n</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_TOU_month_total_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_months</span><span class="p">])</span>
        <span class="n">period_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="c1">#=========================================================================#</span>
    <span class="c1">################# Calculate Flat Demand Charges ###########################</span>
    <span class="c1">#=========================================================================#</span>
    <span class="k">if</span> <span class="n">tariff</span><span class="o">.</span><span class="n">d_flat_exists</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Cast the seasons into a boolean matrix</span>
        <span class="n">flat_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_timesteps</span><span class="p">,</span> <span class="n">n_months</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">flat_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">)),</span><span class="n">month_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Determine the max demand in each month of each year</span>
        <span class="n">load_distributed</span> <span class="o">=</span> <span class="n">load_profile</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">flat_matrix</span>
        <span class="n">flat_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">flat_charges</span> <span class="o">=</span> <span class="n">tiered_calc_vec</span><span class="p">(</span><span class="n">flat_maxs</span><span class="p">,</span> <span class="n">tariff</span><span class="o">.</span><span class="n">d_flat_levels</span><span class="p">,</span> <span class="n">tariff</span><span class="o">.</span><span class="n">d_flat_prices</span><span class="p">)</span>  

    <span class="k">else</span><span class="p">:</span>
        <span class="n">flat_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_months</span><span class="p">])</span>
        <span class="n">flat_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="c1">#=========================================================================#</span>
    <span class="c1">############# Calculate Coincident Peak Demand Charges ####################</span>
    <span class="c1">#=========================================================================#</span>
    <span class="k">if</span> <span class="n">tariff</span><span class="o">.</span><span class="n">coincident_peak_exists</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tariff</span><span class="o">.</span><span class="n">coincident_style</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Input is a n by m array. Each row is a peak period and each set</span>
            <span class="c1"># of columns are the hours that define that period. For example,</span>
            <span class="c1"># [[100,200],[5100,5200]] would have two periods that are defined</span>
            <span class="c1"># by the average demand of hours [100,200] and [5100,5200]</span>
            <span class="c1"># respectively.</span>
            <span class="c1"># Coincident_monthly_periods is a 12-length array that maps the </span>
            <span class="c1"># charges to the billing periods.</span>
            <span class="n">coincident_demand_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">load_profile</span><span class="p">[</span><span class="n">tariff</span><span class="o">.</span><span class="n">coincident_hour_def</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">coincident_charges</span> <span class="o">=</span> <span class="n">tiered_calc_vec</span><span class="p">(</span><span class="n">coincident_demand_levels</span><span class="p">,</span> <span class="n">tariff</span><span class="o">.</span><span class="n">coincident_levels</span><span class="p">,</span> <span class="n">tariff</span><span class="o">.</span><span class="n">coincident_prices</span><span class="p">)</span>
            <span class="n">coincident_monthly_charges</span> <span class="o">=</span> <span class="n">coincident_charges</span><span class="p">[</span><span class="n">tariff</span><span class="o">.</span><span class="n">coincident_monthly_periods</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">coincident_monthly_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">coincident_demand_levels</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#=========================================================================#</span>
    <span class="c1">#################### Calculate Energy Charges #############################</span>
    <span class="c1">#=========================================================================#</span>
    <span class="c1"># Calculate energy charges without full retail NEM</span>
    <span class="k">if</span> <span class="n">tariff</span><span class="o">.</span><span class="n">e_exists</span> <span class="ow">and</span> <span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">export_tariff</span><span class="o">.</span><span class="n">full_retail_nem</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

            <span class="n">imported_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">load_profile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e99</span><span class="p">)</span>
            <span class="n">exported_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">load_profile</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e99</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
            <span class="c1"># Calculate fixed schedule export_tariff </span>
            <span class="c1"># Cast the TOU periods into a boolean matrix</span>
            <span class="n">e_period_export_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">periods_8760</span><span class="p">),</span> <span class="n">export_tariff</span><span class="o">.</span><span class="n">period_tou_n</span><span class="o">*</span><span class="n">n_months</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">e_period_export_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">periods_8760</span><span class="p">))),</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">periods_8760</span><span class="o">+</span><span class="n">month_index</span><span class="o">*</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">period_tou_n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Determine the energy consumed in each period of each month of each year</span>
            <span class="n">load_distributed</span> <span class="o">=</span> <span class="n">exported_profile</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">e_period_export_matrix</span>
            <span class="n">export_period_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Calculate the cost of TOU demand charges</span>
            <span class="n">export_period_credits</span> <span class="o">=</span> <span class="n">tiered_calc_vec</span><span class="p">(</span><span class="n">export_period_sums</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">period_tou_n</span><span class="p">],</span> <span class="mi">12</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">prices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">period_tou_n</span><span class="p">],</span> <span class="mi">12</span><span class="p">))</span>
            
            <span class="n">export_month_total_credits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_months</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_months</span><span class="p">):</span>
                <span class="n">export_month_total_credits</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">export_period_credits</span><span class="p">[(</span><span class="n">month</span><span class="o">*</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">period_tou_n</span><span class="p">):(</span><span class="n">month</span><span class="o">*</span><span class="n">export_tariff</span><span class="o">.</span><span class="n">period_tou_n</span> <span class="o">+</span> <span class="n">export_tariff</span><span class="o">.</span><span class="n">period_tou_n</span><span class="p">)])</span>        
                
            <span class="c1"># Calculate imported energy charges. </span>
            <span class="c1"># Cast the TOU periods into a boolean matrix</span>
            <span class="n">e_period_import_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_tou_8760</span><span class="p">),</span> <span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="o">*</span><span class="n">n_months</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">e_period_import_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_tou_8760</span><span class="p">))),</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_tou_8760</span><span class="o">+</span><span class="n">month_index</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Determine the max demand in each period of each month of each year</span>
            <span class="n">load_distributed</span> <span class="o">=</span> <span class="n">imported_profile</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">e_period_import_matrix</span>
            <span class="n">e_period_import_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Calculate the cost of TOU demand charges</span>
            <span class="n">e_period_import_charges</span> <span class="o">=</span> <span class="n">tiered_calc_vec</span><span class="p">(</span><span class="n">e_period_import_sums</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_levels</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_prices</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
            
            <span class="n">e_month_import_total_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_months</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_months</span><span class="p">):</span>
                <span class="n">e_month_import_total_charges</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_period_import_charges</span><span class="p">[(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">):(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span> <span class="o">+</span> <span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">)])</span>
                
            <span class="n">e_month_total_net_charges</span> <span class="o">=</span> <span class="n">e_month_import_total_charges</span> <span class="o">-</span> <span class="n">export_month_total_credits</span>
    
            <span class="c1"># placeholder        </span>
            <span class="n">e_period_charges</span> <span class="o">=</span> <span class="s2">&quot;placeholder&quot;</span>
            <span class="n">e_period_sums</span> <span class="o">=</span> <span class="s2">&quot;placeholder&quot;</span>

        <span class="c1"># Calculate energy charges with full retail NEM </span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Calculate imported energy charges with full retail NEM</span>
            <span class="c1"># Cast the TOU periods into a boolean matrix</span>
            <span class="n">e_period_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_tou_8760</span><span class="p">),</span> <span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="o">*</span><span class="n">n_months</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">e_period_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_tou_8760</span><span class="p">))),</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_tou_8760</span><span class="o">+</span><span class="n">month_index</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Determine the energy consumed in each period of each month of each year netting exported electricity</span>
            <span class="n">load_distributed</span> <span class="o">=</span> <span class="n">load_profile</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">e_period_matrix</span>
            <span class="n">e_period_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            
            <span class="c1"># Calculate the cost of TOU energy charges netting exported electricity</span>
            <span class="n">e_period_charges</span> <span class="o">=</span> <span class="n">tiered_calc_vec</span><span class="p">(</span><span class="n">e_period_sums</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_levels</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_prices</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

            <span class="n">e_month_total_net_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_months</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_months</span><span class="p">):</span>
                <span class="n">e_month_total_net_charges</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_period_charges</span><span class="p">[(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">):(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span> <span class="o">+</span> <span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">)])</span>
            
            <span class="c1"># Determine the value of NEM</span>
            <span class="c1"># Calculate imported energy charges with zero exported electricity</span>
            <span class="n">imported_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">load_profile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e99</span><span class="p">)</span>

            <span class="c1"># Determine the energy consumed in each period of each month of each year - without exported electricity</span>
            <span class="n">imported_load_distributed</span> <span class="o">=</span> <span class="n">imported_profile</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">e_period_matrix</span>
            <span class="n">e_period_sums_imported</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imported_load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Calculate the cost of TOU energy charges without exported electricity</span>
            <span class="n">e_period_imported_charges</span> <span class="o">=</span> <span class="n">tiered_calc_vec</span><span class="p">(</span><span class="n">e_period_sums_imported</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_levels</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_prices</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
            <span class="n">e_month_total_import_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_months</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_months</span><span class="p">):</span>
                <span class="n">e_month_total_import_charges</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_period_imported_charges</span><span class="p">[(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">):(</span><span class="n">month</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span> <span class="o">+</span> <span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">)])</span>
            
            <span class="c1"># Determine how much  the exported electricity was worth by comparing</span>
            <span class="c1"># bills where it was netted against those where it wasn&#39;t</span>
            <span class="n">export_month_total_credits</span> <span class="o">=</span> <span class="n">e_month_total_net_charges</span> <span class="o">-</span> <span class="n">e_month_total_import_charges</span>
            
            <span class="n">e_period_import_sums</span> <span class="o">=</span> <span class="s1">&#39;placeholder&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e_month_total_net_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">export_month_total_credits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">e_period_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">)</span>
        <span class="n">e_period_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">)</span>
        <span class="n">e_period_import_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">tariff</span><span class="o">.</span><span class="n">e_n</span><span class="p">)</span>
        
    <span class="n">total_monthly_bills</span> <span class="o">=</span> <span class="n">d_TOU_month_total_charges</span> <span class="o">+</span> <span class="n">flat_charges</span> <span class="o">+</span> <span class="n">coincident_monthly_charges</span> <span class="o">+</span> <span class="n">e_month_total_net_charges</span> <span class="o">+</span> <span class="n">tariff</span><span class="o">.</span><span class="n">fixed_charge</span>
    <span class="n">annual_bill</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">total_monthly_bills</span><span class="p">)</span>
        
    <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;annual_bill&#39;</span><span class="p">:</span><span class="n">annual_bill</span><span class="p">,</span>
                    <span class="s1">&#39;d_charges&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_TOU_month_total_charges</span> <span class="o">+</span> <span class="n">flat_charges</span><span class="p">),</span>
                    <span class="s1">&#39;e_charges&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_month_total_net_charges</span><span class="p">),</span>
                    <span class="s1">&#39;monthly_total_bills&#39;</span><span class="p">:</span><span class="n">total_monthly_bills</span><span class="p">,</span>
                    <span class="s1">&#39;monthly_d_charges&#39;</span><span class="p">:</span><span class="n">d_TOU_month_total_charges</span> <span class="o">+</span> <span class="n">flat_charges</span><span class="p">,</span>
                    <span class="s1">&#39;monthly_d_tou_charges&#39;</span><span class="p">:</span><span class="n">d_TOU_month_total_charges</span><span class="p">,</span>
                    <span class="s1">&#39;monthly_d_flat_charges&#39;</span><span class="p">:</span><span class="n">flat_charges</span><span class="p">,</span>
                    <span class="s1">&#39;monthly_e_total_net_charges&#39;</span><span class="p">:</span><span class="n">e_month_total_net_charges</span><span class="p">,</span>
                    <span class="s1">&#39;monthly_e_total_import_charges&#39;</span><span class="p">:</span><span class="n">e_month_total_net_charges</span><span class="o">-</span><span class="n">export_month_total_credits</span><span class="p">,</span>
                    <span class="s1">&#39;monthly_e_total_export_credits&#39;</span><span class="p">:</span><span class="n">export_month_total_credits</span><span class="p">,</span>
                    <span class="s1">&#39;period_kW_maxs&#39;</span><span class="p">:</span><span class="n">period_maxs</span><span class="p">,</span>
                    <span class="s1">&#39;monthly_kW_maxs&#39;</span><span class="p">:</span><span class="n">flat_maxs</span><span class="p">,</span>
                    <span class="s1">&#39;period_e_charges&#39;</span><span class="p">:</span><span class="n">e_period_charges</span><span class="p">,</span>
                    <span class="s1">&#39;period_e_sums&#39;</span><span class="p">:</span><span class="n">e_period_sums</span><span class="p">,</span>
                    <span class="s1">&#39;e_period_import_sums&#39;</span><span class="p">:</span><span class="n">e_period_import_sums</span><span class="p">,</span>
                    <span class="s1">&#39;coincident_monthly_charges&#39;</span><span class="p">:</span><span class="n">coincident_monthly_charges</span><span class="p">,</span>
                    <span class="s1">&#39;coincident_demand_levels&#39;</span><span class="p">:</span><span class="n">coincident_demand_levels</span>
                    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">annual_bill</span><span class="p">,</span> <span class="n">results_dict</span></div>

<span class="c1">#%%</span>
<span class="c1"># Bulk Downloader from URDB API</span>
<div class="viewcode-block" id="download_tariffs_from_urdb"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.download_tariffs_from_urdb">[docs]</a><span class="k">def</span> <span class="nf">download_tariffs_from_urdb</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">sector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">utility</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API request for URDB rates. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    api_key : str</span>
<span class="sd">        Each user should get their own URDB API key: http://en.openei.org/services/api/signup/</span>
<span class="sd">    sector : str</span>
<span class="sd">        One of Residential, Commercial, Industrial, Lighting</span>
<span class="sd">    utility : str, optional</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Dataframe of URDB rates.</span>

<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;utility&#39;</span><span class="p">,</span>
              <span class="s1">&#39;eiaid&#39;</span><span class="p">,</span>
              <span class="s1">&#39;name&#39;</span><span class="p">,</span>
              <span class="s1">&#39;label&#39;</span><span class="p">,</span>
              <span class="s1">&#39;enddate&#39;</span><span class="p">,</span>
              <span class="s1">&#39;demandrateunit&#39;</span><span class="p">,</span>
              <span class="s1">&#39;flatdemandunit&#39;</span><span class="p">,</span>
              <span class="s1">&#39;uri&#39;</span><span class="p">,</span>
              <span class="s1">&#39;sector&#39;</span><span class="p">,</span>
              <span class="s1">&#39;description&#39;</span><span class="p">,</span>
              <span class="s1">&#39;source&#39;</span><span class="p">,</span>
              <span class="s1">&#39;peakkwcapacitymax&#39;</span><span class="p">,</span>
              <span class="s1">&#39;peakkwcapacitymin&#39;</span><span class="p">,</span>
              <span class="s1">&#39;peakkwhuseagemax&#39;</span><span class="p">,</span>
              <span class="s1">&#39;peakkwhuseagemin&#39;</span><span class="p">,</span>
              <span class="s1">&#39;voltagecategory&#39;</span><span class="p">,</span>
              <span class="s1">&#39;phasewiring&#39;</span><span class="p">]</span>
              
    <span class="n">tariffs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>

    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chunk_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">input_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;format&#39;</span><span class="p">:</span><span class="s1">&#39;json&#39;</span><span class="p">,</span>
                <span class="s1">&#39;detail&#39;</span><span class="p">:</span><span class="s1">&#39;full&#39;</span><span class="p">,</span>
                <span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span>
                <span class="s1">&#39;api_key&#39;</span><span class="p">:</span><span class="n">api_key</span><span class="p">}</span>
    
    <span class="k">if</span> <span class="n">sector</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="n">input_params</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>
    <span class="k">if</span> <span class="n">utility</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="n">input_params</span><span class="p">[</span><span class="s1">&#39;ratesforutility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility</span>
        
    <span class="k">while</span> <span class="n">flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">input_params</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
    
        <span class="n">r</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.openei.org/utility_rates?&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">input_params</span><span class="p">)</span>
        
        <span class="n">content</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>
        <span class="n">tariff_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>   
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tariff_chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">tariff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tariff_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;utility&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;utility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;eiaid&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;eiaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;eiaid&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;enddate&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;enddate&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;demandrateunit&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;demandrateunit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;demandrateunit&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;flatdemandunit&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;flatdemandunit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;flatdemandunit&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;uri&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;sector&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;peakkwcapacitymax&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;peakkwcapacitymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;peakkwcapacitymax&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;peakkwcapacitymin&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;peakkwcapacitymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;peakkwcapacitymin&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;peakkwhuseagemax&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;peakkwhuseagemax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;peakkwhuseagemax&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;peakkwhuseagemin&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;peakkwhuseagemin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;peakkwhuseagemin&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;voltagecategory&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;voltagecategory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;voltagecategory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;phasewiring&#39;</span> <span class="ow">in</span> <span class="n">tariff</span><span class="p">:</span> <span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;phasewiring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tariff</span><span class="p">[</span><span class="s1">&#39;phasewiring&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                            
            <span class="n">tariffs</span> <span class="o">=</span> <span class="n">tariffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tariff_chunk</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">count</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_list</span><span class="p">)</span>
            
            <span class="n">chunk_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">print_progress</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">chunk_count</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tariffs</span></div>
    
<span class="c1">#%%</span>
<span class="c1"># Filter tariff_df by a list of keywords in the tariff names, and unit types</span>
    
<div class="viewcode-block" id="filter_tariff_df"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.filter_tariff_df">[docs]</a><span class="k">def</span> <span class="nf">filter_tariff_df</span><span class="p">(</span><span class="n">tariff_df</span><span class="p">,</span> 
                     <span class="n">keyword_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">keyword_list_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">demand_units_to_exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">,</span> <span class="s1">&#39;kVA&#39;</span><span class="p">,</span> <span class="s1">&#39;kW daily&#39;</span><span class="p">,</span> <span class="s1">&#39;hp daily&#39;</span><span class="p">,</span> <span class="s1">&#39;kVA daily&#39;</span><span class="p">],</span> 
                     <span class="n">remove_expired</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>              
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter tariffs based on inclusion (e.g. keywords), or exclusion (e.g. demand units)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tariff_df : pandas.DataFrame</span>
<span class="sd">        dataframe of URDB tariffs created by :func:`download_tariffs_from_urdb`.</span>
<span class="sd">    keyword_list : list of str, optional</span>
<span class="sd">        list of keywords to search for in rate structure.</span>
<span class="sd">    keyword_list_file : str</span>
<span class="sd">        filepath to .txt file containing keywords to search for.</span>
<span class="sd">    demand_units_to_exclude : list of str</span>
<span class="sd">        exclude rates from URDB database if the units are contained in this list. Default values are `hp`,`kVA`,`kW daily`,`hp daily`,`kVA daily`</span>
<span class="sd">    remove_expired : bool</span>
<span class="sd">        exclude expired rates. Default is `True`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">keyword_list_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">keyword_list_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">keyword_list</span> <span class="o">=</span> <span class="n">keyword_list</span> <span class="o">+</span> <span class="n">item</span>
    <span class="k">elif</span> <span class="n">keyword_list</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keyword_list</span> <span class="o">=</span> <span class="n">keyword_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;enter a keyword_list or keyword_list_file&#39;</span><span class="p">)</span>
    
    <span class="n">tariffs_to_exclude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff_df</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
    <span class="n">keyword_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">keyword_list</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">:</span>
        <span class="n">tariffs_that_contain_keyword</span> <span class="o">=</span> <span class="n">tariff_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tariffs_to_exclude</span> <span class="o">=</span> <span class="n">tariffs_that_contain_keyword</span> <span class="o">+</span> <span class="n">tariffs_to_exclude</span>
        <span class="n">keyword_count_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;num_of_tariffs_excluded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tariffs_that_contain_keyword</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">demand_unit</span> <span class="ow">in</span> <span class="n">demand_units_to_exclude</span><span class="p">:</span>
        <span class="n">tariffs_that_contain_unit</span> <span class="o">=</span> <span class="n">tariff_df</span><span class="p">[</span><span class="s1">&#39;demandrateunit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">demand_unit</span>
        <span class="n">tariffs_that_contain_unit</span> <span class="o">+=</span> <span class="n">tariff_df</span><span class="p">[</span><span class="s1">&#39;flatdemandunit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">demand_unit</span>
        <span class="n">tariffs_to_exclude</span> <span class="o">=</span> <span class="n">tariffs_to_exclude</span> <span class="o">+</span> <span class="n">tariffs_that_contain_unit</span>            
        
    <span class="n">tariffs_with_an_end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">tariff_df</span><span class="p">[</span><span class="s1">&#39;enddate&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span>
        
    <span class="n">tariffs_to_exclude</span> <span class="o">=</span> <span class="n">tariffs_to_exclude</span> <span class="o">+</span> <span class="n">tariffs_with_an_end_date</span>
        
    <span class="n">excluded_tariffs</span> <span class="o">=</span> <span class="n">tariff_df</span><span class="p">[</span><span class="n">tariffs_to_exclude</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span>
    <span class="n">included_tariffs</span> <span class="o">=</span> <span class="n">tariff_df</span><span class="p">[</span><span class="n">tariffs_to_exclude</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span>
                             
    <span class="k">return</span> <span class="n">included_tariffs</span><span class="p">,</span> <span class="n">excluded_tariffs</span><span class="p">,</span> <span class="n">keyword_count_df</span></div>
    
<span class="c1">#%%</span>
<span class="c1"># Create 8760 from two 12x24&#39;s</span>
<div class="viewcode-block" id="build_8760_from_12by24s"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.build_8760_from_12by24s">[docs]</a><span class="k">def</span> <span class="nf">build_8760_from_12by24s</span><span class="p">(</span><span class="n">wkday_12by24</span><span class="p">,</span> <span class="n">wkend_12by24</span><span class="p">,</span> <span class="n">start_day</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct long-df (8760) from a weekday and weekend 12by24</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wkday_12by24 : numpy.ndarray</span>
<span class="sd">    wkend_12by24 : numpy.ndarray</span>
<span class="sd">    start_day : int</span>
<span class="sd">        Start day of 6 (default) equates to a Sunday.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">month_hours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">744</span><span class="p">,</span> <span class="mi">1416</span><span class="p">,</span> <span class="mi">2160</span><span class="p">,</span> <span class="mi">2880</span><span class="p">,</span> <span class="mi">3624</span><span class="p">,</span> <span class="mi">4344</span><span class="p">,</span> <span class="mi">5088</span><span class="p">,</span> <span class="mi">5832</span><span class="p">,</span> <span class="mi">6552</span><span class="p">,</span> <span class="mi">7296</span><span class="p">,</span> <span class="mi">8016</span><span class="p">,</span> <span class="mi">8760</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    
    <span class="n">month_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">month</span><span class="p">,</span> <span class="n">hours</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">month_hours</span><span class="p">):</span>
        <span class="n">month_index</span><span class="p">[</span><span class="n">month_hours</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">hours</span><span class="p">]</span> <span class="o">=</span> <span class="n">month</span><span class="o">-</span><span class="mi">1</span>

    <span class="n">period_8760</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">start_day</span> <span class="c1"># Start on 6 because the load profiles we are using start on a Sunday</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8760</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">day</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">period_8760</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">wkday_12by24</span><span class="p">[</span><span class="n">month_index</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">hour</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">period_8760</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">wkend_12by24</span><span class="p">[</span><span class="n">month_index</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">hour</span><span class="p">]</span>
        <span class="n">hour</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">hour</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span> <span class="n">hour</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">day</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">day</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="n">day</span> <span class="o">=</span> <span class="mi">0</span>
            
    <span class="k">return</span> <span class="n">period_8760</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="design_tariff_for_portfolio"><a class="viewcode-back" href="../../source/api.html#python.tariff_functions.design_tariff_for_portfolio">[docs]</a><span class="k">def</span> <span class="nf">design_tariff_for_portfolio</span><span class="p">(</span><span class="n">agent_df</span><span class="p">,</span> <span class="n">avg_rev</span><span class="p">,</span> <span class="n">peak_hour_indicies</span><span class="p">,</span> <span class="n">summer_month_indicies</span><span class="p">,</span> <span class="n">rev_f_d</span><span class="p">,</span> <span class="n">rev_f_e</span><span class="p">,</span> <span class="n">rev_f_fixed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds a tariff that would extract a given $/kWh from a portfolio of customers.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    agent_df : pandas.DataFrame</span>
<span class="sd">        Dataframe of agents</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        agent_df.load_profile : numpy.ndarray</span>
<span class="sd">        agent_df.weight : numpy.ndarray</span>

<span class="sd">    avg_rev : float</span>
<span class="sd">        $/kWh that the tariff would extract from the given portfolio of customers.</span>
<span class="sd">    rev_f_d : array-like</span>
<span class="sd">        Revenue strucutre for demand charges.</span>
<span class="sd">        Format is [fraction of total revenue, fraction that comes from tou charges, fraction that comes from flat charges]</span>
<span class="sd">        ex: [0.4875, 0.5, 0.5]</span>
<span class="sd">    rev_f_d : array-like</span>
<span class="sd">        Revenue strucutre for energy charges. </span>
<span class="sd">        Format is [fraction of total revenue, fraction that comes from off-peak hours, fraction that comes from on-peak hours]</span>
<span class="sd">        ex: [0.4875, 0.20, 0.8]</span>
<span class="sd">    rev_f_fixed : array-like</span>
<span class="sd">        [fraction of revenue from fixed monthly charges].</span>
<span class="sd">        ex: [0.025]</span>
<span class="sd">        </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    1)  Peak hours are the same between demand and energy.</span>
<span class="sd">    2)  Peak hours only occur during the summer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Construct the 12x24 matricies for the given peak hours</span>
    <span class="n">d_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">d_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">e_wkend_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">e_wkday_12by24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">peak_hour</span> <span class="ow">in</span> <span class="n">peak_hour_indicies</span><span class="p">:</span>
        <span class="n">d_wkday_12by24</span><span class="p">[</span><span class="n">summer_month_indicies</span><span class="p">,</span> <span class="n">peak_hour</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">e_wkday_12by24</span><span class="p">[</span><span class="n">summer_month_indicies</span><span class="p">,</span> <span class="n">peak_hour</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># Build an 8760 of peak hours   </span>
    <span class="n">d_tou_8760</span> <span class="o">=</span> <span class="n">build_8760_from_12by24s</span><span class="p">(</span><span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="n">d_wkend_12by24</span><span class="p">,</span> <span class="n">start_day</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">d_tou_n</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="c1"># 8760 vector of month numbers</span>
    <span class="n">month_hours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">744</span><span class="p">,</span> <span class="mi">1416</span><span class="p">,</span> <span class="mi">2160</span><span class="p">,</span> <span class="mi">2880</span><span class="p">,</span> <span class="mi">3624</span><span class="p">,</span> <span class="mi">4344</span><span class="p">,</span> <span class="mi">5088</span><span class="p">,</span> <span class="mi">5832</span><span class="p">,</span> <span class="mi">6552</span><span class="p">,</span> <span class="mi">7296</span><span class="p">,</span> <span class="mi">8016</span><span class="p">,</span> <span class="mi">8760</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">month_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8760</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">month</span><span class="p">,</span> <span class="n">hours</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">month_hours</span><span class="p">):</span>
        <span class="n">month_index</span><span class="p">[</span><span class="n">month_hours</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">hours</span><span class="p">]</span> <span class="o">=</span> <span class="n">month</span><span class="o">-</span><span class="mi">1</span>
    
    <span class="n">period_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">8760</span><span class="p">,</span> <span class="n">d_tou_n</span><span class="o">*</span><span class="mi">12</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
    <span class="n">period_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8760</span><span class="p">)),</span><span class="n">d_tou_8760</span><span class="o">+</span><span class="n">month_index</span><span class="o">*</span><span class="n">d_tou_n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1"># Define the dataframes that energy and demand values will be recorded in</span>
    <span class="n">bld_peak_demands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">bld_flat_demands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">bld_peak_energy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">bld_offpeak_energy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="c1"># Determine the peak demands and energy consumption for each building in</span>
    <span class="c1"># the portfolio</span>
    <span class="k">for</span> <span class="n">bld</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">load_profile</span> <span class="o">=</span> <span class="n">agent_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bld</span><span class="p">,</span> <span class="s1">&#39;load_profile&#39;</span><span class="p">]</span>
        <span class="n">load_distributed</span> <span class="o">=</span> <span class="n">load_profile</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">period_matrix</span>
    
        <span class="c1"># Determine the max demands</span>
        <span class="n">period_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">bld_peak_demands</span><span class="p">[</span><span class="n">bld</span><span class="p">]</span> <span class="o">=</span> <span class="n">period_maxs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">bld_flat_demands</span><span class="p">[</span><span class="n">bld</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">period_maxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Determine energy consumption</span>
        <span class="n">period_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">load_distributed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">bld_peak_energy</span><span class="p">[</span><span class="n">bld</span><span class="p">]</span> <span class="o">=</span> <span class="n">period_sums</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">bld_offpeak_energy</span><span class="p">[</span><span class="n">bld</span><span class="p">]</span> <span class="o">=</span> <span class="n">period_sums</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
    
    <span class="c1"># Calculate the normalized revenue from each category</span>
    <span class="n">normalized_consumption</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">agent_df</span><span class="p">[</span><span class="s1">&#39;f_in_this_portfolio&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">agent_df</span><span class="p">[</span><span class="s1">&#39;aec&#39;</span><span class="p">])</span>
    <span class="n">norm_rev</span> <span class="o">=</span> <span class="n">normalized_consumption</span> <span class="o">*</span> <span class="n">avg_rev</span>
    <span class="n">norm_rev_d_peak</span> <span class="o">=</span> <span class="n">norm_rev</span> <span class="o">*</span> <span class="n">rev_f_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rev_f_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm_rev_d_flat</span> <span class="o">=</span> <span class="n">norm_rev</span> <span class="o">*</span> <span class="n">rev_f_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rev_f_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">norm_rev_e_peak</span> <span class="o">=</span> <span class="n">norm_rev</span> <span class="o">*</span> <span class="n">rev_f_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rev_f_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm_rev_e_offpeak</span> <span class="o">=</span> <span class="n">norm_rev</span> <span class="o">*</span> <span class="n">rev_f_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rev_f_e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">norm_rev_fixed</span> <span class="o">=</span> <span class="n">norm_rev</span> <span class="o">*</span> <span class="n">rev_f_fixed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Calculate the prices that would result in the required revenue being</span>
    <span class="c1"># collected, for each category</span>
    <span class="n">charge_d_peak</span> <span class="o">=</span> <span class="n">norm_rev_d_peak</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bld_peak_demands</span><span class="p">)</span><span class="o">*</span><span class="n">agent_df</span><span class="p">[</span><span class="s1">&#39;f_in_this_portfolio&#39;</span><span class="p">])</span>
    <span class="n">charge_d_flat</span> <span class="o">=</span> <span class="n">norm_rev_d_flat</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bld_flat_demands</span><span class="p">)</span><span class="o">*</span><span class="n">agent_df</span><span class="p">[</span><span class="s1">&#39;f_in_this_portfolio&#39;</span><span class="p">])</span>
    <span class="n">charge_e_peak</span> <span class="o">=</span> <span class="n">norm_rev_e_peak</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bld_peak_energy</span><span class="p">)</span><span class="o">*</span><span class="n">agent_df</span><span class="p">[</span><span class="s1">&#39;f_in_this_portfolio&#39;</span><span class="p">])</span>
    <span class="n">charge_e_offpeak</span> <span class="o">=</span> <span class="n">norm_rev_e_offpeak</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bld_offpeak_energy</span><span class="p">)</span><span class="o">*</span><span class="n">agent_df</span><span class="p">[</span><span class="s1">&#39;f_in_this_portfolio&#39;</span><span class="p">])</span>
    <span class="n">charge_fixed_monthly</span> <span class="o">=</span> <span class="n">norm_rev_fixed</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">agent_df</span><span class="p">[</span><span class="s1">&#39;f_in_this_portfolio&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">12.0</span>
    
    <span class="c1"># Prepare variables for tariff definition</span>
    <span class="n">d_tou_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1e9</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">]])</span>
    <span class="n">d_tou_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge_d_peak</span><span class="p">]])</span>
    <span class="n">d_flat_levels</span> <span class="o">=</span> <span class="mf">1e9</span>
    <span class="n">d_flat_prices</span> <span class="o">=</span> <span class="n">charge_d_flat</span>
    <span class="n">e_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1e9</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">]])</span>
    <span class="n">e_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">charge_e_offpeak</span><span class="p">,</span> <span class="n">charge_e_peak</span><span class="p">]])</span> <span class="c1"># Check this!!! TODO</span>
    
    <span class="c1"># Define tariff</span>
    <span class="n">tariff</span> <span class="o">=</span> <span class="n">Tariff</span><span class="p">()</span>
    <span class="n">tariff</span><span class="o">.</span><span class="n">define_d_flat</span><span class="p">(</span><span class="n">d_flat_levels</span><span class="p">,</span> <span class="n">d_flat_prices</span><span class="p">)</span>
    <span class="n">tariff</span><span class="o">.</span><span class="n">define_d_tou</span><span class="p">(</span><span class="n">d_wkday_12by24</span><span class="p">,</span> <span class="n">d_wkend_12by24</span><span class="p">,</span> <span class="n">d_tou_levels</span><span class="p">,</span> <span class="n">d_tou_prices</span><span class="p">)</span>
    <span class="n">tariff</span><span class="o">.</span><span class="n">define_e</span><span class="p">(</span><span class="n">e_wkday_12by24</span><span class="p">,</span> <span class="n">e_wkend_12by24</span><span class="p">,</span> <span class="n">e_levels</span><span class="p">,</span> <span class="n">e_prices</span><span class="p">)</span>
    <span class="n">tariff</span><span class="o">.</span><span class="n">fixed_charge</span> <span class="o">=</span> <span class="n">charge_fixed_monthly</span>
    
    <span class="n">export_tariff</span> <span class="o">=</span> <span class="n">Export_Tariff</span><span class="p">(</span><span class="n">full_retail_nem</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bld</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">load_profile</span> <span class="o">=</span> <span class="n">agent_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bld</span><span class="p">,</span> <span class="s1">&#39;load_profile&#39;</span><span class="p">]</span>
        <span class="n">original_bill</span><span class="p">,</span> <span class="n">original_bill_results</span> <span class="o">=</span> <span class="n">bill_calculator</span><span class="p">(</span><span class="n">load_profile</span><span class="p">,</span> <span class="n">tariff</span><span class="p">,</span> <span class="n">export_tariff</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">tariff</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, NREL

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>